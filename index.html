<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POKER On Jack Tall Back</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA5HoMt3eYJgWZel8ka4SDdsVmvP62zj2c",
            authDomain: "pokerti-633ba.firebaseapp.com",
            projectId: "pokerti-633ba",
            storageBucket: "pokerti-633ba.firebasestorage.app",
            messagingSenderId: "883744429166",
            appId: "1:883744429166:web:7e091d7e8fcae6251c827f"
        };
        
        try {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            
            signInAnonymously(auth)
                .then(() => {
                    console.log("Firebase inicializado!");
                    window.db = db;
                    window.doc = doc;
                    window.onSnapshot = onSnapshot;
                    window.setDoc = setDoc;
                })
                .catch((error) => console.error("ERRO NO LOGIN ANÔNIMO:", error));
        } catch (error) {
            console.error("ERRO CRÍTICO NA INICIALIZAÇÃO DO FIREBASE:", error);
        }
    </script>

    <style>
        /* Seus estilos aqui... */
        body { font-family: 'Roboto Condensed', sans-serif; background-color: #032a05; background-image: radial-gradient(circle, #0a4f0d 0%, #032a05 100%); color: #e5e7eb; }
        h1, h2, h3, button, th { font-family: 'Oswald', sans-serif; }
        .player-row.eliminated { background-color: rgba(40, 40, 40, 0.5); text-decoration: line-through; color: #9ca3af; }
    </style>
</head>
<body class="min-h-screen">

    <div id="main-content" class="container mx-auto p-4">
        <h1 class="text-4xl text-center font-bold mb-6 text-white">POKER On Jack Tall Back</h1>
        
        <div id="game-controls">
            <div class="overflow-x-auto">
                <table class="min-w-full bg-black/30">
                    <thead>
                        <tr>
                            <th class="px-4 py-2 text-left text-yellow-300">Jogador</th>
                            </tr>
                    </thead>
                    <tbody id="player-table-body">
                        </tbody>
                </table>
            </div>
            <div class="mt-8 flex justify-center gap-4">
                <button id="add-player-btn" class="bg-blue-700 hover:bg-blue-800 text-white font-bold py-3 px-6 rounded-lg">Adicionar Jogador</button>
                <button id="reset-game-btn" class="bg-red-700 hover:bg-red-800 text-white font-bold py-3 px-6 rounded-lg">Resetar Jogo (com Senha)</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const waitForFirebase = setInterval(() => {
                if (window.db) {
                    clearInterval(waitForFirebase);
                    initializeAppLogic();
                }
            }, 100);

            const initializeAppLogic = () => {
                const { db, doc, onSnapshot, setDoc } = window;

                const CORRECT_PASSWORD = 'poker';
                const initialPlayers = ["DANILO", "Bronx", "Gustavo Lui", "Guilherme Lui", "Luiz", "Miudinho", "Vitor", "Lucas", "Yago", "Alexandre", "Lucas Costa", "Prado", "Rodrigo Boy", "Jogador 14", "Jogador 15", "Jogador 16"];
                
                let playersData = [];
                let isUpdatingFromFirebase = false;
                // ✅ VARIÁVEL PARA GUARDAR A VERSÃO ATUAL DO JOGO
                let currentGameId = null;

                const gameDocRef = doc(db, 'pokerGame', 'gameState');

                const playerTableBody = document.getElementById('player-table-body');
                const addPlayerBtn = document.getElementById('add-player-btn');
                const resetGameBtn = document.getElementById('reset-game-btn');
                
                const saveData = async () => {
                    if (isUpdatingFromFirebase) {
                        console.log("%cSAVE BLOQUEADO: Atualização do Firebase em progresso.", "color: orange;");
                        return;
                    }
                    if (!currentGameId) {
                        console.error("SAVE BLOQUEADO: ID do jogo inválido. Não é seguro salvar.");
                        return;
                    }
                    console.log(`%cSALVANDO DADOS PARA O JOGO ${currentGameId}...`, "color: blue;", playersData);
                    try {
                        // Sempre salva os dados junto com a assinatura/ID do jogo
                        await setDoc(gameDocRef, { 
                            gameId: currentGameId,
                            players: playersData 
                        });
                    } catch (error) {
                        console.error("Erro ao salvar dados:", error);
                    }
                };
                
                const renderPlayers = () => {
                    playerTableBody.innerHTML = '';
                    if (playersData.length === 0) {
                        playerTableBody.innerHTML = '<tr><td class="p-4 text-center">Nenhum jogador...</td></tr>';
                        return;
                    }
                    playersData.forEach(player => {
                        const tr = document.createElement('tr');
                        tr.className = `player-row ${player.eliminated ? 'eliminated' : ''}`;
                        tr.innerHTML = `<td class="border px-4 py-2"><input type="text" value="${player.name}" class="bg-transparent w-full"></td>`;
                        playerTableBody.appendChild(tr);
                    });
                };

                const resetGame = async () => {
                    // ✅ GERA UMA NOVA ASSINATURA ÚNICA PARA O NOVO JOGO
                    currentGameId = `game_${Date.now()}`;
                    console.log(`%cRESETANDO JOGO. NOVO ID DO JOGO: ${currentGameId}`, "color: red; font-weight: bold;");
                    
                    playersData = initialPlayers.map(name => ({ name, eliminated: false }));
                    
                    renderPlayers();
                    
                    // Salva os novos dados com a nova assinatura
                    await saveData();
                };

                addPlayerBtn.addEventListener('click', () => {
                    if (isUpdatingFromFirebase) return;
                    playersData.push({ name: 'Novo Jogador', eliminated: false });
                    renderPlayers();
                    saveData();
                });
                
                resetGameBtn.addEventListener('click', () => {
                    const password = prompt("Para resetar o jogo, digite a senha de administrador:");
                    if (password === CORRECT_PASSWORD) {
                        resetGame();
                    } else if (password !== null) {
                        alert("Senha incorreta.");
                    }
                });

                // --- LISTENER PRINCIPAL DO FIREBASE (COM LÓGICA ANTI-FANTASMA) ---

                onSnapshot(gameDocRef, (docSnapshot) => {
                    console.log("%cSNAPSHOT RECEBIDO!", "color: green;");
                    isUpdatingFromFirebase = true;

                    if (docSnapshot.exists()) {
                        const data = docSnapshot.data();

                        // ✅ LÓGICA DE VALIDAÇÃO DA ASSINATURA
                        if (currentGameId === null) {
                            // Se é o primeiro carregamento, confiamos nos dados e guardamos o ID
                            currentGameId = data.gameId;
                            console.log(`Primeiro carregamento. Sincronizando com o jogo ID: ${currentGameId}`);
                        }

                        // Se os dados do Firebase não têm a assinatura ou ela é diferente da que esperamos,
                        // são dados de um cliente fantasma.
                        if (!data.gameId || data.gameId !== currentGameId) {
                            console.error(`DADOS INVÁLIDOS REJEITADOS! ID esperado: ${currentGameId}, ID recebido: ${data.gameId || 'NENHUM'}. Isso provavelmente é de um cliente fantasma.`);
                            console.warn("Forçando o reenvio dos dados corretos para sobrescrever os dados inválidos...");
                            
                            // Libera a trava e força o envio dos dados corretos que estão na memória
                            isUpdatingFromFirebase = false;
                            saveData(); 
                            
                            // Interrompe o processamento destes dados inválidos
                            return; 
                        }

                        console.log(`Dados válidos recebidos para o jogo ${currentGameId}. Carregando ${data.players.length} jogadores.`);
                        playersData = data.players || [];

                    } else {
                        console.log("Documento não existe. Criando um novo jogo do zero.");
                        resetGame();
                    }
                    
                    renderPlayers();

                    setTimeout(() => {
                        isUpdatingFromFirebase = false;
                        console.log("%cTrava liberada.", "color: gray;");
                    }, 500);
                });
            };
        });
    </script>
</body>
</html>
