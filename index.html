<script type="module">
        // --- IMPORTS DO FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

        // --- INICIALIZAÇÃO DO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyA5HoMt3eYJgWZel8ka4SDdsVmvP62zj2c",
            authDomain: "pokerti-633ba.firebaseapp.com",
            projectId: "pokerti-633ba",
            storageBucket: "pokerti-633ba.firebasestorage.app",
            messagingSenderId: "883744429166",
            appId: "1:883744429166:web:7e091d7e8fcae6251c827f"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            
            signInAnonymously(auth)
                .then(() => {
                    console.log("Firebase inicializado. Sessão de leitura anônima criada.");
                    initializeAppLogic(db, auth);
                })
                .catch((error) => console.error("ERRO NO LOGIN ANÔNIMO:", error));

        } catch (error) {
            console.error("ERRO CRÍTICO NA INICIALIZAÇÃO DO FIREBASE:", error);
        }

        // --- LÓGICA PRINCIPAL DA APLICAÇÃO ---
        const initializeAppLogic = (db, auth) => {
            
            // --- CONSTANTES ---
            const CORRECT_PASSWORD = 'poker';
            const ACTION_VALUE = 30;
            const DB_COLLECTION = 'pokerGame';
            const GAME_STATE_DOC_ID = 'gameState';
            const TIMER_STATE_DOC_ID = 'timerState';
            const PRIZE_CONFIG_DOC_ID = 'prizeConfig';
            const initialPlayers = ["DANILO", "Bronx", "Gustavo Lui", "Guilherme Lui", "Luiz", "Miudinho", "Vitor", "Lucas", "Yago", "Rodrigo Boy", "Lucas Costa", "Alexandre Costa", "Prado", "Raphinha", "NJ", "NJ2", "NJ3"];
            const initialPrizes = [50, 30, 20];
            const blindLevels = [
                { blinds: "100/100" }, { blinds: "100/200" }, { blinds: "200/400" },
                { blinds: "300/600" }, { blinds: "400/800" }, { blinds: "500/1000" },
                { blinds: "600/1200" },
                { blinds: "600/1200", note: "Último nível para Rebuys e Add-on" },
                { isBreak: true, note: "Pausa - 15 Minutos", duration: 15 },
                { blinds: "800/1600" }, { blinds: "1000/2000" }, { blinds: "1500/3000" },
                { blinds: "2000/4000" }, { blinds: "3000/6000" }, { blinds: "4000/8000" },
                { blinds: "5000/10000" }, { blinds: "6000/12000" }, { blinds: "8000/16000" },
                { blinds: "10000/20000" }, { blinds: "15000/30000" }, { blinds: "20000/40000" },
                { blinds: "25000/50000" }, { blinds: "30000/60000" }, { blinds: "40000/80000" },
                { blinds: "50000/100000" }
            ];

            // --- REFERÊNCIAS DE DOCUMENTOS NO FIREBASE ---
            const gameStateDocRef = doc(db, DB_COLLECTION, GAME_STATE_DOC_ID);
            const timerStateDocRef = doc(db, DB_COLLECTION, TIMER_STATE_DOC_ID);
            const prizeConfigDocRef = doc(db, DB_COLLECTION, PRIZE_CONFIG_DOC_ID);

            // --- ELEMENTOS DO DOM ---
            const adminLoginBtn = document.getElementById('admin-login-btn');
            const loginModal = document.getElementById('login-modal');
            const loginCancelBtn = document.getElementById('login-cancel-btn');
            const loginForm = document.getElementById('login-form');
            const passwordInput = document.getElementById('password');
            const loginError = document.getElementById('login-error');
            const mainContent = document.getElementById('main-content');
            const gameControls = document.getElementById('game-controls');
            const logoutBtn = document.getElementById('logout-btn');
            const playerTableBody = document.getElementById('player-table-body');
            const addPlayerBtn = document.getElementById('add-player-btn');
            const resetGameBtn = document.getElementById('reset-game-btn');
            const modal = document.getElementById('confirmation-modal');
            const modalText = document.getElementById('modal-text');
            const modalConfirmBtn = document.getElementById('modal-confirm-btn');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            const passwordModal = document.getElementById('password-modal');
            const passwordInputModal = document.getElementById('password-input-modal');
            const passwordErrorModal = document.getElementById('password-error-modal');
            const passwordConfirmBtn = document.getElementById('password-confirm-btn');
            const passwordCancelBtn = document.getElementById('password-cancel-btn');
            const prizeGrid = document.getElementById('prize-grid');
            const publicPrizeGrid = document.getElementById('public-prize-grid');
            const publicInfoSection = document.getElementById('public-info-section');
            const addPrizeBtn = document.getElementById('add-prize-btn');
            const percentageWarning = document.getElementById('percentage-warning');
            const timerDisplay = document.getElementById('timer-display');
            const currentBlindsDisplay = document.getElementById('current-blinds');
            const nextBlindsDisplay = document.getElementById('next-blinds');
            const timerControlButton = document.getElementById('timer-control-btn');
            const resetTimerButton = document.getElementById('reset-timer-btn');
            const levelDurationInput = document.getElementById('level-duration');
            const levelIndicator = document.getElementById('level-indicator');
            const prevLevelBtn = document.getElementById('prev-level-btn');
            const nextLevelBtn = document.getElementById('next-level-btn');
            const blindsNote = document.getElementById('blinds-note');
            const standingsList = document.getElementById('standings-list');
            const finalStandingsSection = document.getElementById('final-standings-section');
            const muteBtn = document.getElementById('mute-btn');
            const soundOnIcon = document.getElementById('sound-on-icon');
            const soundOffIcon = document.getElementById('sound-off-icon');

            // --- VARIÁVEIS DE ESTADO ---
            let confirmCallback = null;
            let timerInterval = null;
            let timerState = { timeLeft: 15 * 60, currentLevel: 0, isRunning: false };
            let playersData = [];
            let isUpdatingFromFirebase = false;
            let isMuted = localStorage.getItem('pokerMuted') === 'true';
            let inputTimeout = null;

            // --- LÓGICA DE LOGIN E LOGOUT ---
            const openLoginModal = () => {
                passwordInput.value = '';
                loginError.textContent = '';
                loginModal.classList.remove('hidden');
                passwordInput.focus();
            };
            const closeLoginModal = () => loginModal.classList.add('hidden');
            const showLoggedInState = () => {
                gameControls.classList.remove('hidden');
                publicInfoSection.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
                adminLoginBtn.classList.add('hidden');
                sessionStorage.setItem('pokerAppLoggedIn', 'true');
            };
            const showLoggedOutState = () => {
                sessionStorage.removeItem('pokerAppLoggedIn');
                gameControls.classList.add('hidden');
                logoutBtn.classList.add('hidden');
                adminLoginBtn.classList.remove('hidden');
                publicInfoSection.classList.remove('hidden');
            };
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (passwordInput.value === CORRECT_PASSWORD) {
                    showLoggedInState();
                    closeLoginModal();
                } else {
                    loginError.textContent = 'Palavra-passe incorreta.';
                }
                passwordInput.value = '';
            });
            logoutBtn.addEventListener('click', showLoggedOutState);
            adminLoginBtn.addEventListener('click', openLoginModal);
            loginCancelBtn.addEventListener('click', closeLoginModal);
            loginModal.addEventListener('click', (e) => { if(e.target === loginModal) closeLoginModal(); });

            // --- LÓGICA DE SOM ---
            const updateMuteButton = () => {
                soundOnIcon.classList.toggle('hidden', isMuted);
                soundOffIcon.classList.toggle('hidden', !isMuted);
            };
            const playSound = (soundFunction) => {
                if (isMuted) return;
                soundFunction();
            };
            const createSound = (type, frequency, duration, startFreq = null) => {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                if (!audioContext) return;
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.type = type;
                oscillator.frequency.setValueAtTime(startFreq || frequency, audioContext.currentTime);
                if(startFreq) {
                    oscillator.frequency.exponentialRampToValueAtTime(frequency, audioContext.currentTime + (duration * 0.7));
                }
                gainNode.gain.setValueAtTime(1.0, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + duration);
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            };
            const playWarningSound = () => {
                createSound('triangle', 1500, 0.2);
                setTimeout(() => createSound('triangle', 1500, 0.2), 300);
            };
            const playLevelUpSound = () => createSound('sawtooth', 800, 0.8, 1500);
            const playCountdownBeep = () => createSound('sine', 880, 0.2);
            muteBtn.addEventListener('click', () => {
                isMuted = !isMuted;
                localStorage.setItem('pokerMuted', isMuted);
                updateMuteButton();
            });
            
            // --- LÓGICA DO TEMPORIZADOR DE BLINDS ---
            // (Nenhuma alteração nesta seção)
            const updateChipAvailability = () => {
                const rebuysAllowed = timerState.currentLevel < 8;
                document.body.classList.toggle('rebuys-disabled', !rebuysAllowed);
            };
            const updateTimerDisplay = () => {
                const minutes = Math.floor(timerState.timeLeft / 60).toString().padStart(2, '0');
                const seconds = (timerState.timeLeft % 60).toString().padStart(2, '0');
                timerDisplay.textContent = `${minutes}:${seconds}`;
                const currentLevelInfo = blindLevels[timerState.currentLevel];
                if (currentLevelInfo && currentLevelInfo.isBreak) {
                    currentBlindsDisplay.textContent = "PAUSA";
                    blindsNote.textContent = currentLevelInfo.note || '';
                } else {
                    currentBlindsDisplay.textContent = currentLevelInfo ? currentLevelInfo.blinds : '--/--';
                    blindsNote.textContent = currentLevelInfo?.note || '';
                }
                let nextBlindLevel = blindLevels.find((level, index) => index > timerState.currentLevel && !level.isBreak);
                nextBlindsDisplay.textContent = nextBlindLevel ? nextBlindLevel.blinds : 'Fim';
                levelIndicator.textContent = `(NÍVEL ${timerState.currentLevel + 1}/${blindLevels.length})`;
                prevLevelBtn.disabled = timerState.currentLevel === 0;
                nextLevelBtn.disabled = timerState.currentLevel >= blindLevels.length - 1;
                updateChipAvailability();
            };
            const runLocalTimer = () => {
                if (timerState.timeLeft > 0) {
                    timerState.timeLeft--;
                    updateTimerDisplay();
                    if (timerState.timeLeft <= 10 && timerState.timeLeft > 0) playSound(playCountdownBeep);
                    else if (timerState.timeLeft === 60) playSound(playWarningSound);
                } else {
                    if(sessionStorage.getItem('pokerAppLoggedIn') === 'true') nextLevel();
                }
            };
            const stopLocalTimer = () => {
                clearInterval(timerInterval);
                timerInterval = null;
            };
            const saveTimerStateToFirebase = async (state) => await setDoc(timerStateDocRef, { ...state, lastUpdateTime: state.isRunning ? serverTimestamp() : null }, { merge: true });
            const startTimer = () => { if (!timerState.isRunning) { timerState.isRunning = true; saveTimerStateToFirebase(timerState); } };
            const pauseTimer = () => { if (timerState.isRunning) { timerState.isRunning = false; saveTimerStateToFirebase(timerState); } };
            const setLevel = (levelIndex) => {
                const newLevelInfo = blindLevels[levelIndex];
                const duration = newLevelInfo.isBreak ? newLevelInfo.duration : parseInt(levelDurationInput.value);
                timerState = { currentLevel: levelIndex, timeLeft: duration * 60, isRunning: timerState.isRunning };
                saveTimerStateToFirebase(timerState);
            };
            const nextLevel = () => {
                playSound(playLevelUpSound);
                if (timerState.currentLevel < blindLevels.length - 1) setLevel(timerState.currentLevel + 1);
                else pauseTimer();
            };
            const prevLevel = () => { if (timerState.currentLevel > 0) setLevel(timerState.currentLevel - 1); };
            const resetTimer = () => { pauseTimer(); setLevel(0); };
            onSnapshot(timerStateDocRef, (docSnapshot) => {
                const latestState = docSnapshot.exists() ? docSnapshot.data() : { timeLeft: parseInt(levelDurationInput.value) * 60, currentLevel: 0, isRunning: false, lastUpdateTime: null };
                if (latestState.isRunning) {
                    const now = Date.now();
                    const lastUpdate = latestState.lastUpdateTime?.toMillis() || now;
                    const timeElapsed = Math.floor((now - lastUpdate) / 1000);
                    latestState.timeLeft = Math.max(0, latestState.timeLeft - timeElapsed);
                    if (!timerInterval) {
                        timerInterval = setInterval(runLocalTimer, 1000);
                        timerControlButton.textContent = 'PAUSAR';
                        timerControlButton.classList.replace('bg-green-600', 'bg-yellow-600');
                    }
                } else {
                    stopLocalTimer();
                    timerControlButton.textContent = 'INICIAR';
                    timerControlButton.classList.replace('bg-yellow-600', 'bg-green-600');
                }
                timerState = latestState;
                updateTimerDisplay();
            });
            timerControlButton.addEventListener('click', () => timerState.isRunning ? pauseTimer() : startTimer());
            resetTimerButton.addEventListener('click', resetTimer);
            prevLevelBtn.addEventListener('click', prevLevel);
            nextLevelBtn.addEventListener('click', nextLevel);
            levelDurationInput.addEventListener('change', () => {
                if (!timerState.isRunning && !blindLevels[timerState.currentLevel].isBreak) {
                    timerState.timeLeft = parseInt(levelDurationInput.value) * 60;
                    updateTimerDisplay();
                    saveTimerStateToFirebase(timerState);
                }
            });

            // --- LÓGICA PRINCIPAL DO JOGO ---
            const saveData = async () => {
                if (isUpdatingFromFirebase) return;
                try {
                    await setDoc(gameStateDocRef, { players: playersData });
                } catch (error) { console.error("Erro ao salvar dados dos jogadores: ", error); }
            };
            const savePrizeDataToFirebase = async () => {
                const prizePercentages = Array.from(document.querySelectorAll('.prize-percent-input')).map(input => parseFloat(input.value) || 0);
                await setDoc(prizeConfigDocRef, { percentages: prizePercentages });
            };

            const calculateTotals = () => {
                let grandTotal = 0, totalBuyIns = 0, totalRebuys = 0, totalAddOns = 0;
                playersData.forEach(p => {
                    if (p.buyInChecked) { grandTotal += ACTION_VALUE; totalBuyIns++; }
                    if (p.rebuysChecked) { const count = p.rebuysChecked.filter(Boolean).length; grandTotal += count * ACTION_VALUE; totalRebuys += count; }
                    if (p.addOnChecked) { grandTotal += ACTION_VALUE; totalAddOns++; }
                });
                document.getElementById('total-buy-ins').textContent = totalBuyIns;
                document.getElementById('total-rebuys').textContent = totalRebuys;
                document.getElementById('total-add-ons').textContent = totalAddOns;
                document.getElementById('grand-total').textContent = `R$ ${grandTotal.toFixed(2)}`;
                document.getElementById('total-players-summary').textContent = playersData.filter(p => !p.eliminated).length;
                document.getElementById('total-buyins-summary').textContent = totalBuyIns;
                document.getElementById('total-rebuys-summary').textContent = totalRebuys;
                document.getElementById('total-addons-summary').textContent = totalAddOns;
                const totalPercent = Array.from(document.querySelectorAll('.prize-percent-input')).reduce((sum, input) => sum + (parseFloat(input.value) || 0), 0);
                percentageWarning.classList.toggle('hidden', Math.round(totalPercent) === 100 || totalPercent === 0);
                document.querySelectorAll('.prize-item').forEach(item => {
                    const percent = parseFloat(item.querySelector('.prize-percent-input').value) || 0;
                    item.querySelector('.prize-value-display').textContent = `R$ ${((grandTotal * percent) / 100).toFixed(2)}`;
                });
                updatePublicPrizes(grandTotal);
                calculateAndRenderStandings();
            };
            
            const calculateAndRenderStandings = () => {
                const eliminatedPlayers = playersData.map((p, i) => ({...p, originalIndex: i})).filter(p => p.eliminated && p.eliminationTimestamp);
                finalStandingsSection.classList.toggle('hidden', eliminatedPlayers.length === 0);
                if (eliminatedPlayers.length === 0) {
                    standingsList.innerHTML = '<li class="text-gray-400">Nenhum jogador eliminado ainda.</li>';
                    return;
                }
                eliminatedPlayers.sort((a, b) => (a.eliminationTimestamp?.toMillis() || 0) - (b.eliminationTimestamp?.toMillis() || 0));
                standingsList.innerHTML = '';
                eliminatedPlayers.forEach((player, index) => {
                    const rank = playersData.length - index;
                    const li = document.createElement('li');
                    li.className = 'text-lg';
                    li.innerHTML = `<span class="font-bold">${rank}º</span> - ${player.name}`;
                    standingsList.appendChild(li);
                });
            };
            
            const updatePublicPrizes = (grandTotal) => {
                const prizeInputs = document.querySelectorAll('.prize-item');
                if (prizeInputs.length === 0) {
                    publicPrizeGrid.innerHTML = '<p class="col-span-full text-gray-400">Premiação não definida.</p>';
                    return;
                }
                publicPrizeGrid.innerHTML = '';
                prizeInputs.forEach((item, index) => {
                    const place = index + 1;
                    const percent = parseFloat(item.querySelector('.prize-percent-input').value) || 0;
                    const value = ((grandTotal * percent) / 100).toFixed(2);
                    let color = place === 1 ? 'text-yellow-300' : place === 2 ? 'text-gray-300' : 'text-orange-400';
                    publicPrizeGrid.innerHTML += `<div class="prize-item-public bg-black/20 p-4 rounded-lg"><p class="block text-sm font-medium uppercase">${place}º LUGAR</p><p class="mt-2 text-xl font-semibold ${color}">R$ ${value}</p></div>`;
                });
            };

            const renderTable = () => {
                playerTableBody.innerHTML = '';
                const eliminatedSorted = playersData.map((p, i) => ({ ...p, originalIndex: i })).filter(p => p.eliminated && p.eliminationTimestamp).sort((a, b) => (a.eliminationTimestamp?.toMillis() || 0) - (b.eliminationTimestamp?.toMillis() || 0));
                const rankMap = new Map();
                eliminatedSorted.forEach((p, i) => rankMap.set(p.originalIndex, playersData.length - i));
                playersData.forEach((p, index) => createPlayerRow(p, rankMap.get(index)));
                calculateTotals();
            };
            
            const createPlayerRow = (player, rank) => {
                const tr = document.createElement('tr');
                tr.className = `player-row hover:bg-yellow-400/10 transition-colors duration-150 ${player.eliminated ? 'eliminated' : ''}`;
                tr.dataset.index = playersData.indexOf(player);

                let rebuyCheckboxes = '';
                for(let i = 0; i < 10; i++) {
                    rebuyCheckboxes += `<td class="px-0.5 sm:px-1 py-3 text-center"><label class="chip-label"><input type="checkbox" class="chip-checkbox rebuy-cb" ${player.rebuysChecked?.[i] ? 'checked' : ''}><span class="chip"></span></label></td>`;
                }

                tr.innerHTML = `
                    <td class="px-2 sm:px-4 py-3 whitespace-nowrap flex items-center">
                        ${player.eliminated && rank ? `<span class="elimination-rank">${rank}º</span>` : ''}
                        <input type="text" placeholder="Nome do Jogador" value="${player.name}" class="player-name w-full bg-transparent focus:bg-black/20 rounded-md p-1 -m-1 outline-none focus:ring-1 focus:ring-yellow-500" ${player.eliminated ? 'disabled' : ''}>
                    </td>
                    <td class="px-1 sm:px-2 py-3 text-center"><label class="chip-label"><input type="checkbox" class="chip-checkbox buy-in-cb" ${player.buyInChecked ? 'checked' : ''}><span class="chip"></span></label></td>
                    ${rebuyCheckboxes}
                    <td class="px-1 sm:px-2 py-3 text-center"><label class="chip-label"><input type="checkbox" class="chip-checkbox add-on-cb" ${player.addOnChecked ? 'checked' : ''}><span class="chip"></span></label></td>
                    <td class="player-total px-2 sm:px-4 py-3 text-right font-medium text-gray-300 whitespace-nowrap">R$ 0,00</td>
                    <td class="px-2 sm:px-3 py-3 text-center flex items-center justify-center gap-2">
                        <button class="eliminate-player-btn text-gray-400 hover:text-yellow-500 transition-colors" title="${player.eliminated ? 'Restaurar Jogador' : 'Eliminar Jogador'}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M11 1a1 1 0 0 1 1 1v2a1 1 0 0 1-2 0V2a1 1 0 0 1 1-1zM5 1a1 1 0 0 1 1 1v2a1 1 0 0 1-2 0V2a1 1 0 0 1 1-1zm6 8a1 1 0 0 1 1 1v2a1 1 0 0 1-2 0v-2a1 1 0 0 1 1-1zM5 9a1 1 0 0 1 1 1v2a1 1 0 0 1-2 0v-2a1 1 0 0 1 1-1z"/><path d="M8 0a.5.5 0 0 1 .5.5V3h3a.5.5 0 0 1 0 1h-3v2.03a1.5 1.5 0 0 1-2 0V4H3.5a.5.5 0 0 1 0-1H6V.5A.5.5 0 0 1 6.5 0h3A.5.5 0 0 1 8 0zM2 4.5A1.5 1.5 0 0 1 3.5 6H4a.5.5 0 0 1 0 1H3.5A1.5 1.5 0 0 1 2 5.5v-1A1.5 1.5 0 0 1 3.5 3H4a.5.5 0 0 1 0-1H3.5A1.5 1.5 0 0 1 2 3.5v1zM12.5 6A1.5 1.5 0 0 1 14 4.5v-1A1.5 1.5 0 0 1 12.5 2H12a.5.5 0 0 1 0-1h.5A1.5 1.5 0 0 1 14 2.5v1A1.5 1.5 0 0 1 12.5 5H12a.5.5 0 0 1 0 1h.5zM12.5 12A1.5 1.5 0 0 1 14 10.5v-1A1.5 1.5 0 0 1 12.5 8H12a.5.5 0 0 1 0-1h.5A1.5 1.5 0 0 1 14 8.5v1A1.5 1.5 0 0 1 12.5 11H12a.5.5 0 0 1 0 1h.5zM2 10.5A1.5 1.5 0 0 1 3.5 12H4a.5.5 0 0 1 0 1H3.5A1.5 1.5 0 0 1 2 11.5v-1A1.5 1.5 0 0 1 3.5 9H4a.5.5 0 0 1 0-1H3.5A1.5 1.5 0 0 1 2 9.5v1z"/></svg>
                        </button>
                        <button class="delete-player-btn text-gray-400 hover:text-red-500 transition-colors" title="Remover da Lista">
                           <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5M8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5m3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0"/></svg>
                        </button>
                    </td>`;
                playerTableBody.appendChild(tr);
            };

            const loadData = () => {
                onSnapshot(gameStateDocRef, (docSnapshot) => {
                    isUpdatingFromFirebase = true;
                    playersData = (docSnapshot.exists() && docSnapshot.data().players) 
                        ? docSnapshot.data().players 
                        : initialPlayers.map(name => ({ name, buyInChecked: false, rebuysChecked: Array(10).fill(false), addOnChecked: false, eliminated: false, eliminationTimestamp: null }));
                    renderTable();
                    isUpdatingFromFirebase = false;
                }, (error) => console.error("Erro ao ouvir dados do jogo:", error));

                onSnapshot(prizeConfigDocRef, (docSnapshot) => {
                    prizeGrid.innerHTML = '';
                    const prizesToLoad = (docSnapshot.exists() && docSnapshot.data().percentages) ? docSnapshot.data().percentages : initialPrizes;
                    prizesToLoad.forEach((value, index) => createPrizeField(index + 1, value));
                    calculateTotals();
                }, (error) => console.error("Erro ao ouvir dados de premiação:", error));
            };

            // --- MODAIS E AÇÕES ---
            const openModal = (text, onConfirm) => { modalText.textContent = text; confirmCallback = onConfirm; modal.classList.remove('hidden'); };
            const closeModal = () => { modal.classList.add('hidden'); confirmCallback = null; };
            const openPasswordModal = () => { passwordInputModal.value = ''; passwordErrorModal.textContent = ''; passwordModal.classList.remove('hidden'); passwordInputModal.focus(); };
            const closePasswordModal = () => passwordModal.classList.add('hidden');
            const resetGame = () => {
                closePasswordModal();
                openModal('Tem a certeza que deseja reiniciar o jogo? Todos os dados serão perdidos.', async () => {
                    await setDoc(gameStateDocRef, { players: initialPlayers.map(name => ({ name, buyInChecked: false, rebuysChecked: Array(10).fill(false), addOnChecked: false, eliminated: false, eliminationTimestamp: null })) });
                    await setDoc(prizeConfigDocRef, { percentages: initialPrizes });
                    await setDoc(timerStateDocRef, { timeLeft: parseInt(levelDurationInput.value) * 60, currentLevel: 0, isRunning: false, lastUpdateTime: null });
                    closeModal();
                });
            };
            resetGameBtn.addEventListener('click', openPasswordModal);
            passwordConfirmBtn.addEventListener('click', () => { if (passwordInputModal.value === CORRECT_PASSWORD) resetGame(); else passwordErrorModal.textContent = 'Palavra-passe incorreta.'; });
            passwordCancelBtn.addEventListener('click', closePasswordModal);
            passwordModal.addEventListener('click', (e) => { if (e.target === passwordModal) closePasswordModal(); });
            modalConfirmBtn.addEventListener('click', () => { if(confirmCallback) confirmCallback(); });
            modalCancelBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
            
            // --- EVENT LISTENERS DE INTERAÇÃO ---
            addPlayerBtn.addEventListener('click', () => {
                playersData.push({ name: '', buyInChecked: false, rebuysChecked: Array(10).fill(false), addOnChecked: false, eliminated: false, eliminationTimestamp: null });
                saveData();
            });
            playerTableBody.addEventListener('click', (event) => {
                const row = event.target.closest('.player-row');
                const deleteBtn = event.target.closest('.delete-player-btn');
                const eliminateBtn = event.target.closest('.eliminate-player-btn');
                if (!row || (!deleteBtn && !eliminateBtn)) return;

                const rowIndex = parseInt(row.dataset.index);
                if (isNaN(rowIndex) || !playersData[rowIndex]) return;

                if (deleteBtn) {
                    openModal(`Deseja remover ${playersData[rowIndex].name || 'Jogador sem nome'} da lista?`, () => {
                        playersData.splice(rowIndex, 1);
                        saveData();
                        closeModal();
                    });
                } else if (eliminateBtn) {
                    const player = playersData[rowIndex];
                    player.eliminated = !player.eliminated;
                    player.eliminationTimestamp = player.eliminated ? serverTimestamp() : null;
                    console.log('Eliminating player', rowIndex, player);
                    saveData();
                }
            });
            mainContent.addEventListener('input', (e) => {
                clearTimeout(inputTimeout);
                const target = e.target;
                if (target.matches('.prize-percent-input')) {
                    inputTimeout = setTimeout(savePrizeDataToFirebase, 800);
                    return;
                }
                const row = target.closest('.player-row');
                if (!row) return;
                const rowIndex = parseInt(row.dataset.index);
                if (isNaN(rowIndex) || !playersData[rowIndex]) return;
                const player = playersData[rowIndex];
                if (target.matches('.player-name')) player.name = target.value;
                else if (target.matches('.buy-in-cb')) player.buyInChecked = target.checked;
                else if (target.matches('.add-on-cb')) player.addOnChecked = target.checked;
                else if (target.matches('.rebuy-cb')) {
                    const rebuyIndex = Array.from(row.querySelectorAll('.rebuy-cb')).indexOf(target);
                    if (rebuyIndex !== -1) player.rebuysChecked[rebuyIndex] = target.checked;
                }
                inputTimeout = setTimeout(saveData, 800);
            });
            addPrizeBtn.addEventListener('click', () => { createPrizeField(prizeGrid.children.length + 1); savePrizeDataToFirebase(); });
            prizeGrid.addEventListener('click', (event) => {
                if (event.target.closest('.remove-prize-btn')) {
                    event.target.closest('.prize-item').remove();
                    prizeGrid.querySelectorAll('.prize-item label').forEach((label, i) => label.textContent = `${i + 1}º LUGAR`);
                    savePrizeDataToFirebase();
                }
            });

            // --- CARREGAMENTO INICIAL ---
            if (sessionStorage.getItem('pokerAppLoggedIn') === 'true') showLoggedInState(); else showLoggedOutState();
            updateMuteButton();
            loadData();
        };
    </script>
</body>
</html>
