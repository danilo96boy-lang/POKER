<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POKER On Jack Tall Back</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA5HoMt3eYJgWZel8ka4SDdsVmvP62zj2c",
            authDomain: "pokerti-633ba.firebaseapp.com",
            projectId: "pokerti-633ba",
            storageBucket: "pokerti-633ba.firebasestorage.app",
            messagingSenderId: "883744429166",
            appId: "1:883744429166:web:7e091d7e8fcae6251c827f"
        };
        
        try {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            
            signInAnonymously(auth)
                .then(() => {
                    console.log("Firebase inicializado e login anônimo bem-sucedido!");
                    window.db = db;
                    window.doc = doc;
                    window.onSnapshot = onSnapshot;
                    window.setDoc = setDoc;
                    window.serverTimestamp = serverTimestamp;
                })
                .catch((error) => console.error("ERRO NO LOGIN ANÔNIMO DO FIREBASE:", error));
        } catch (error) {
            console.error("ERRO CRÍTICO NA INICIALIZAÇÃO DO FIREBASE:", error);
        }
    </script>

    <style>
        body { font-family: 'Roboto Condensed', sans-serif; background-color: #032a05; background-image: radial-gradient(circle, #0a4f0d 0%, #032a05 100%); }
        h1, h2, h3, button, th { font-family: 'Oswald', sans-serif; }
        .modal-overlay { transition: opacity 0.3s ease; }
        .chip-label { display: inline-flex; align-items: center; justify-content: center; cursor: pointer; }
        .chip-checkbox { appearance: none; -webkit-appearance: none; position: absolute; opacity: 0; }
        .chip { height: 28px; width: 28px; border-radius: 50%; background-color: #4a5568; border: 2px solid #a0aec0; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease-in-out; box-shadow: 0 2px 4px rgba(0,0,0,0.4), inset 0 2px 2px rgba(255,255,255,0.2); position: relative; }
        .chip::before { content: ''; position: absolute; height: 18px; width: 18px; border-radius: 50%; border: 1px dashed #a0aec0; }
        .buy-in-cb + .chip { background-color: #2b6cb0; }
        .rebuy-cb + .chip { background-color: #c53030; }
        .add-on-cb + .chip { background-color: #2f855a; }
        .chip-checkbox:checked + .chip { transform: scale(1.1); box-shadow: 0 0 10px 3px var(--glow-color, #f7fafc), 0 2px 4px rgba(0,0,0,0.4), inset 0 1px 1px rgba(0,0,0,0.2); border-color: #fff; }
        .buy-in-cb:checked + .chip { --glow-color: #63b3ed; }
        .rebuy-cb:checked + .chip { --glow-color: #f56565; }
        .add-on-cb:checked + .chip { --glow-color: #68d391; }
        .chip-checkbox:checked + .chip::before { border: 2px solid #fff; }
        .player-row.eliminated { background-color: rgba(40, 40, 40, 0.5); text-decoration: line-through; color: #9ca3af; }
        .player-row.eliminated .player-name, .player-row.eliminated .chip-checkbox { pointer-events: none; }
    </style>
</head>
<body class="bg-green-900 text-gray-200 min-h-screen">

    <div id="main-content" class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="relative text-center mb-6">
            <h1 class="text-4xl sm:text-5xl font-bold text-white tracking-wider uppercase" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">
                <span class="text-red-500">♦</span> POKER On Jack Tall Back <span class="text-red-500">♥</span>
            </h1>
            <p class="text-gray-300 mt-2 text-lg">Gerencie o jogo em tempo real.</p>
            <button id="admin-login-btn" class="absolute top-0 right-0 bg-blue-700 hover:bg-blue-800 text-white font-bold py-2 px-4 rounded-lg shadow-lg" title="Login Admin">Admin</button>
            <button id="logout-btn" class="absolute top-0 right-0 bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded-lg shadow-lg hidden" title="Sair">Sair</button>
        </header>

        <div id="blinds-timer-section" class="mb-8 bg-black/30 backdrop-blur-sm rounded-xl shadow-lg p-4 sm:p-6 border-2 border-yellow-600/50">
            <h2 class="text-2xl font-bold text-white uppercase tracking-wider text-center mb-2">Temporizador de Blinds <span id="level-indicator" class="text-yellow-400"></span></h2>
            <div id="blinds-note" class="text-center text-yellow-200 text-sm h-5 mb-2"></div>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-center text-center">
                <div class="sm:text-left">
                    <p class="text-sm text-yellow-300 uppercase">Nível Atual</p>
                    <p id="current-blinds" class="text-xl sm:text-2xl font-bold text-white">--/--</p>
                </div>
                <div class="font-mono text-6xl sm:text-7xl text-yellow-400 font-bold flex items-center justify-center gap-4">
                    <button id="prev-level-btn" class="text-4xl text-gray-400 hover:text-white transition-colors" title="Nível Anterior">&lt;&lt;</button>
                    <span id="timer-display">--:--</span>
                    <button id="next-level-btn" class="text-4xl text-gray-400 hover:text-white transition-colors" title="Próximo Nível">&gt;&gt;</button>
                </div>
                <div class="sm:text-right">
                    <p class="text-sm text-yellow-300 uppercase">Próximo Nível</p>
                    <p id="next-blinds" class="text-xl sm:text-2xl font-bold text-white">--/--</p>
                </div>
            </div>
            <div class="mt-4 flex justify-center items-center gap-2 sm:gap-4">
                <div class="flex items-center gap-2">
                    <label for="level-duration" class="text-sm">Duração (min):</label>
                    <input type="number" id="level-duration" value="15" class="w-16 bg-gray-900/50 text-white text-center rounded-md p-1">
                </div>
                <button id="timer-control-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg uppercase text-sm">Iniciar</button>
                <button id="reset-timer-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg uppercase text-sm">Reiniciar</button>
            </div>
        </div>

        <div id="summary-panel" class="mb-8 grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
            <div class="bg-black/30 backdrop-blur-sm p-4 rounded-xl border-2 border-yellow-600/30">
                <h3 class="text-sm font-semibold text-yellow-300 uppercase">Jogadores Ativos</h3>
                <p id="total-players-summary" class="text-3xl font-bold text-white">0</p>
            </div>
            <div class="bg-black/30 backdrop-blur-sm p-4 rounded-xl border-2 border-yellow-600/30">
                <h3 class="text-sm font-semibold text-yellow-300 uppercase">Total Buy-ins</h3>
                <p id="total-buyins-summary" class="text-3xl font-bold text-white">0</p>
            </div>
            <div class="bg-black/30 backdrop-blur-sm p-4 rounded-xl border-2 border-yellow-600/30">
                <h3 class="text-sm font-semibold text-yellow-300 uppercase">Total Rebuys</h3>
                <p id="total-rebuys-summary" class="text-3xl font-bold text-white">0</p>
            </div>
            <div class="bg-black/30 backdrop-blur-sm p-4 rounded-xl border-2 border-yellow-600/30">
                <h3 class="text-sm font-semibold text-yellow-300 uppercase">Total Add-ons</h3>
                <p id="total-addons-summary" class="text-3xl font-bold text-white">0</p>
            </div>
        </div>

        <div id="public-prize-section" class="mb-8">
            <div class="bg-black/30 backdrop-blur-sm rounded-xl shadow-lg p-6 border-2 border-yellow-600/50 max-w-2xl mx-auto">
                 <h2 class="text-2xl font-bold text-white uppercase tracking-wider text-center mb-4">♠ Premiação ♣</h2>
                 <div id="public-prize-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 text-center"></div>
            </div>
        </div>

        <div id="game-controls" class="hidden">
            <div class="bg-black/30 backdrop-blur-sm rounded-xl shadow-lg overflow-hidden border-2 border-yellow-600/50">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-yellow-600/30">
                        <thead class="bg-black/25">
                            <tr>
                                <th class="px-2 sm:px-4 py-3 text-left text-xs font-semibold text-yellow-300 uppercase tracking-wider">Jogador</th>
                                <th class="px-1 sm:px-3 py-3 text-center text-xs font-semibold text-yellow-300 uppercase tracking-wider">Buy-in</th>
                                <th colspan="10" class="px-2 sm:px-3 py-3 text-center text-xs font-semibold text-yellow-300 uppercase tracking-wider">Rebuys</th>
                                <th class="px-1 sm:px-3 py-3 text-center text-xs font-semibold text-yellow-300 uppercase tracking-wider">Add-on</th>
                                <th class="px-2 sm:px-4 py-3 text-right text-xs font-semibold text-yellow-300 uppercase tracking-wider">Total (R$)</th>
                                <th class="px-2 sm:px-3 py-3 text-center text-xs font-semibold text-yellow-300 uppercase tracking-wider">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="player-table-body" class="divide-y divide-yellow-600/30"></tbody>
                        <tfoot class="bg-black/25 border-t-2 border-yellow-600/50">
                            <tr>
                                <td class="px-2 sm:px-4 py-4 font-semibold text-white">TOTAIS (Ação: R$ 30,00)</td>
                                <td id="total-buy-ins" class="px-1 sm:px-3 py-4 text-center font-semibold text-white">0</td>
                                <td colspan="10" id="total-rebuys" class="px-2 sm:px-3 py-4 text-center font-semibold text-white">0</td>
                                <td id="total-add-ons" class="px-1 sm:px-3 py-4 text-center font-semibold text-white">0</td>
                                <td id="grand-total" class="px-2 sm:px-4 py-4 text-right font-bold text-2xl text-yellow-400">R$ 0,00</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            <p class="text-center text-xs text-gray-400 mt-2 sm:hidden">Arraste a tabela para os lados para ver todas as colunas.</p>
            <div class="mt-8">
                <div id="prize-section" class="bg-black/30 backdrop-blur-sm rounded-xl shadow-lg p-6 border-2 border-yellow-600/50 max-w-2xl mx-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-white uppercase tracking-wider">♠ Premiação ♣</h2>
                        <button id="add-prize-btn" class="bg-yellow-600 hover:bg-yellow-700 text-black font-bold h-8 w-8 rounded-full flex items-center justify-center" title="Adicionar Prêmio">+</button>
                    </div>
                    <div id="prize-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-center"></div>
                    <p id="percentage-warning" class="text-center text-xs text-red-400 mt-4 hidden">A soma das porcentagens deve ser 100.</p>
                </div>
            </div>
            <div class="mt-8 flex justify-center gap-4">
                <button id="add-player-btn" class="bg-blue-700 hover:bg-blue-800 text-white font-bold py-3 px-6 rounded-lg shadow-lg">Adicionar Jogador</button>
                <button id="reset-game-btn" class="bg-red-700 hover:bg-red-800 text-white font-bold py-3 px-6 rounded-lg shadow-lg">Resetar Jogo</button>
            </div>
        </div>
    </div>

    <div id="login-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm flex justify-center items-center hidden z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-11/12 max-w-sm border-2 border-yellow-500">
            <h3 class="text-lg font-bold text-center mb-4">Acesso de Administrador</h3>
            <form id="login-form">
                <input id="password" type="password" placeholder="Palavra-passe" autocomplete="current-password" class="w-full bg-gray-900/50 text-white text-center rounded-md p-2 mb-3" required>
                <p id="login-error" class="text-red-400 text-center text-xs h-4 mb-4"></p>
                <div class="flex justify-center gap-4">
                    <button id="login-cancel-btn" type="button" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg">Cancelar</button>
                    <button type="submit" class="bg-yellow-600 hover:bg-yellow-700 text-black font-bold py-2 px-6 rounded-lg">Entrar</button>
                </div>
            </form>
        </div>
    </div>
    <div id="confirmation-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm flex justify-center items-center hidden z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-11/12 max-w-sm border-2 border-yellow-500">
            <p id="modal-text" class="text-center text-lg mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="modal-cancel-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg">Cancelar</button>
                <button id="modal-confirm-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">Confirmar</button>
            </div>
        </div>
    </div>
    <div id="password-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm flex justify-center items-center hidden z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-11/12 max-w-sm border-2 border-yellow-500">
            <h3 class="text-lg font-bold text-center mb-4">Confirmação de Ação</h3>
            <p class="text-center text-sm mb-4">Para continuar, insira a palavra-passe de administrador.</p>
            <input id="password-input-modal" type="password" class="w-full bg-gray-900/50 text-white text-center rounded-md p-2 mb-2">
            <p id="password-error-modal" class="text-red-400 text-center text-xs h-4 mb-4"></p>
            <div class="flex justify-center gap-4">
                <button id="password-cancel-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg">Cancelar</button>
                <button id="password-confirm-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">Confirmar</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const waitForFirebase = setInterval(() => {
        if (window.db) {
            clearInterval(waitForFirebase);
            initializeAppLogic();
        }
    }, 100);

    const initializeAppLogic = () => {
        const { db, doc, onSnapshot, setDoc, serverTimestamp } = window;

        // --- SELETORES DE ELEMENTOS ---
        const UIElements = {
            mainContent: document.getElementById('main-content'),
            adminLoginBtn: document.getElementById('admin-login-btn'), logoutBtn: document.getElementById('logout-btn'),
            loginModal: document.getElementById('login-modal'), loginForm: document.getElementById('login-form'),
            passwordInput: document.getElementById('password'), loginError: document.getElementById('login-error'),
            loginCancelBtn: document.getElementById('login-cancel-btn'), gameControls: document.getElementById('game-controls'),
            publicPrizeSection: document.getElementById('public-prize-section'), playerTableBody: document.getElementById('player-table-body'),
            addPlayerBtn: document.getElementById('add-player-btn'), resetGameBtn: document.getElementById('reset-game-btn'),
            confirmationModal: document.getElementById('confirmation-modal'), modalText: document.getElementById('modal-text'),
            modalConfirmBtn: document.getElementById('modal-confirm-btn'), modalCancelBtn: document.getElementById('modal-cancel-btn'),
            passwordModal: document.getElementById('password-modal'), passwordInputModal: document.getElementById('password-input-modal'),
            passwordErrorModal: document.getElementById('password-error-modal'), passwordConfirmBtn: document.getElementById('password-confirm-btn'),
            passwordCancelBtn: document.getElementById('password-cancel-btn'), prizeGrid: document.getElementById('prize-grid'),
            addPrizeBtn: document.getElementById('add-prize-btn'), percentageWarning: document.getElementById('percentage-warning'),
            publicPrizeGrid: document.getElementById('public-prize-grid'),
            timerDisplay: document.getElementById('timer-display'), currentBlindsDisplay: document.getElementById('current-blinds'),
            nextBlindsDisplay: document.getElementById('next-blinds'), timerControlButton: document.getElementById('timer-control-btn'),
            resetTimerButton: document.getElementById('reset-timer-btn'), levelDurationInput: document.getElementById('level-duration'),
            levelIndicator: document.getElementById('level-indicator'), prevLevelBtn: document.getElementById('prev-level-btn'),
            nextLevelBtn: document.getElementById('next-level-btn'), blindsNote: document.getElementById('blinds-note')
        };

        // --- CONSTANTES E ESTADO DO JOGO ---
        const CORRECT_PASSWORD = 'poker';
        const ACTION_VALUE = 30;
        const initialPlayers = ["DANILO", "Bronx", "Gustavo Lui", "Guilherme Lui", "Luiz", "Miudinho", "Vitor", "Lucas", "Yago", "Alexandre", "Lucas Costa", "Prado", "Rodrigo Boy", "Novo Jogador 1"];
        const initialPrizes = [50, 30, 20];
        const blindLevels = [ { blinds: "100/100" }, { blinds: "100/200" }, { blinds: "200/400" }, { blinds: "300/600" }, { blinds: "400/800" }, { blinds: "500/1000" }, { blinds: "600/1200" }, { blinds: "600/1200", note: "Último nível para Rebuys e Add-on" }, { isBreak: true, note: "Pausa - 15 Minutos", duration: 15 }, { blinds: "800/1600" }, { blinds: "1000/2000" }, { blinds: "1500/3000" }, { blinds: "2000/4000" }, { blinds: "3000/6000" }, { blinds: "4000/8000" }, { blinds: "5000/10000" }, { blinds: "6000/12000" }, { blinds: "8000/16000" }, { blinds: "10000/20000" }, { blinds: "15000/30000" }, { blinds: "20000/40000" } ];
        
        let playersData = [];
        let confirmCallback = null;
        let timerState = { timeLeft: 15 * 60, currentLevel: 0, isRunning: false };
        let timerInterval = null;
        
        // ✅ VARIÁVEIS DE CONTROLE DA SINCRONIZAÇÃO
        let isUpdatingFromFirebase = false; 
        let currentGameId = null;

        const gameDocRef = doc(db, 'pokerGame', 'gameState');
        const timerDocRef = doc(db, 'pokerGame', 'timerState');

        // ✅ LÓGICA DE DADOS CORRIGIDA
        const saveData = async () => {
            if (isUpdatingFromFirebase) return;
            if (!currentGameId) { console.error("SAVE BLOQUEADO: ID do jogo inválido."); return; }
            try {
                await setDoc(gameDocRef, { gameId: currentGameId, players: playersData });
                const prizePercentages = Array.from(document.querySelectorAll('.prize-percent-input')).map(input => input.value);
                localStorage.setItem('pokerPrizeData', JSON.stringify(prizePercentages));
            } catch (error) {
                console.error("Erro ao salvar dados:", error);
            }
        };

        // ✅ LÓGICA DE RESET CORRIGIDA
        const resetGame = async () => {
            closePasswordModal();
            currentGameId = `game_${Date.now()}`;
            console.log(`%cRESETANDO JOGO. NOVO ID: ${currentGameId}`, "color: red; font-weight: bold;");
            
            playersData = initialPlayers.map(name => ({
                name, buyInChecked: false, rebuysChecked: Array(10).fill(false),
                addOnChecked: false, eliminated: false
            }));
            
            localStorage.setItem('pokerPrizeData', JSON.stringify(initialPrizes));
            await saveData();
            
            const initialDuration = UIElements.levelDurationInput ? parseInt(UIElements.levelDurationInput.value, 10) : 15;
            await setDoc(timerDocRef, { timeLeft: initialDuration * 60, currentLevel: 0, isRunning: false, lastUpdateTime: null });
        };

        // --- FUNÇÕES DE RENDERIZAÇÃO E UI (ORIGINAIS) ---
        const renderAll = () => {
            UIElements.playerTableBody.innerHTML = '';
            playersData.forEach(p => createPlayerRow(p));
            calculateTotals();
            loadPrizes();
        };

        const createPlayerRow = (player) => {
            const tr = document.createElement('tr');
            tr.className = 'player-row hover:bg-yellow-400/10 transition-colors duration-150';
            let rebuyCheckboxes = '';
            for(let i = 0; i < 10; i++) {
                const isChecked = player.rebuysChecked && player.rebuysChecked[i];
                rebuyCheckboxes += `<td class="px-0.5 sm:px-1 py-3 text-center"><label class="chip-label"><input type="checkbox" class="chip-checkbox rebuy-cb" ${isChecked ? 'checked' : ''}><span class="chip"></span></label></td>`;
            }
            tr.innerHTML = `
                <td class="px-2 sm:px-4 py-3 whitespace-nowrap"><input type="text" placeholder="Nome" value="${player.name}" class="player-name w-full bg-transparent focus:bg-black/20 rounded-md p-1 -m-1 outline-none"></td>
                <td class="px-1 sm:px-2 py-3 text-center"><label class="chip-label"><input type="checkbox" class="chip-checkbox buy-in-cb" ${player.buyInChecked ? 'checked' : ''}><span class="chip"></span></label></td>
                ${rebuyCheckboxes}
                <td class="px-1 sm:px-2 py-3 text-center"><label class="chip-label"><input type="checkbox" class="chip-checkbox add-on-cb" ${player.addOnChecked ? 'checked' : ''}><span class="chip"></span></label></td>
                <td class="player-total px-2 sm:px-4 py-3 text-right font-medium">R$ 0,00</td>
                <td class="px-2 sm:px-3 py-3 text-center flex items-center justify-center gap-2">
                    <button class="eliminate-player-btn text-gray-400 hover:text-yellow-500" title="Eliminar/Restaurar"><svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M11 1a1 1 0 0 1 1 1v2a1 1 0 0 1-2 0V2a1 1 0 0 1 1-1zM5 1a1 1 0 0 1 1 1v2a1 1 0 0 1-2 0V2a1 1 0 0 1 1-1zm6 8a1 1 0 0 1 1 1v2a1 1 0 0 1-2 0v-2a1 1 0 0 1 1-1zM5 9a1 1 0 0 1 1 1v2a1 1 0 0 1-2 0v-2a1 1 0 0 1 1-1z"/><path d="M8 0a.5.5 0 0 1 .5.5V3h3a.5.5 0 0 1 0 1h-3v2.03a1.5 1.5 0 0 1-2 0V4H3.5a.5.5 0 0 1 0-1H6V.5A.5.5 0 0 1 6.5 0h3A.5.5 0 0 1 8 0zM2 4.5A1.5 1.5 0 0 1 3.5 6H4a.5.5 0 0 1 0 1H3.5A1.5 1.5 0 0 1 2 5.5v-1A1.5 1.5 0 0 1 3.5 3H4a.5.5 0 0 1 0-1H3.5A1.5 1.5 0 0 1 2 3.5v1zM12.5 6A1.5 1.5 0 0 1 14 4.5v-1A1.5 1.5 0 0 1 12.5 2H12a.5.5 0 0 1 0-1h.5A1.5 1.5 0 0 1 14 2.5v1A1.5 1.5 0 0 1 12.5 5H12a.5.5 0 0 1 0 1h.5zM12.5 12A1.5 1.5 0 0 1 14 10.5v-1A1.5 1.5 0 0 1 12.5 8H12a.5.5 0 0 1 0-1h.5A1.5 1.5 0 0 1 14 8.5v1A1.5 1.5 0 0 1 12.5 11H12a.5.5 0 0 1 0 1h.5zM2 10.5A1.5 1.5 0 0 1 3.5 12H4a.5.5 0 0 1 0 1H3.5A1.5 1.5 0 0 1 2 11.5v-1A1.5 1.5 0 0 1 3.5 9H4a.5.5 0 0 1 0-1H3.5A1.5 1.5 0 0 1 2 9.5v1z"/></svg></button>
                    <button class="delete-player-btn text-gray-400 hover:text-red-500" title="Remover da Lista"><svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5M8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5m3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0"/></svg></button>
                </td>`;
            if(player.eliminated) tr.classList.add('eliminated');
            UIElements.playerTableBody.appendChild(tr);
        };
        
        const calculateTotals = () => {
            let grandTotal = 0, totalBuyIns = 0, totalRebuys = 0, totalAddOns = 0, activePlayers = 0;
            playersData.forEach((player, index) => {
                let playerTotal = 0;
                if (player.buyInChecked) { playerTotal += ACTION_VALUE; totalBuyIns++; }
                if (player.rebuysChecked) { const count = player.rebuysChecked.filter(Boolean).length; playerTotal += count * ACTION_VALUE; totalRebuys += count; }
                if (player.addOnChecked) { playerTotal += ACTION_VALUE; totalAddOns++; }
                if (!player.eliminated) activePlayers++;
                const row = UIElements.playerTableBody.children[index];
                if(row) row.querySelector('.player-total').textContent = `R$ ${playerTotal.toFixed(2)}`;
            });
            grandTotal = (totalBuyIns + totalRebuys + totalAddOns) * ACTION_VALUE;
            document.getElementById('total-buy-ins').textContent = totalBuyIns;
            document.getElementById('total-rebuys').textContent = totalRebuys;
            document.getElementById('total-add-ons').textContent = totalAddOns;
            document.getElementById('grand-total').textContent = `R$ ${grandTotal.toFixed(2)}`;
            document.getElementById('total-players-summary').textContent = activePlayers;
            document.getElementById('total-buyins-summary').textContent = totalBuyIns;
            document.getElementById('total-rebuys-summary').textContent = totalRebuys;
            document.getElementById('total-addons-summary').textContent = totalAddOns;
            updatePublicPrizes(grandTotal);
        };

        const createPrizeField = (place, value = 0) => {
            const prizeItem = document.createElement('div');
            prizeItem.className = 'prize-item relative bg-black/20 p-4 rounded-lg';
            let color = place === 1 ? 'text-yellow-300' : (place === 2 ? 'text-gray-300' : 'text-orange-400');
            prizeItem.innerHTML = `
                <label class="block text-sm font-medium uppercase">${place}º Lugar</label>
                <input type="number" value="${value}" class="prize-percent-input mt-2 w-24 bg-gray-900/50 text-white text-center rounded-md p-2" placeholder="%">
                <p class="prize-value-display mt-2 text-xl font-semibold ${color}">R$ 0,00</p>
                ${place > 1 ? `<button class="remove-prize-btn absolute top-2 right-2 text-gray-500 hover:text-red-400">&times;</button>` : ''}`;
            UIElements.prizeGrid.appendChild(prizeItem);
        };

        const loadPrizes = () => {
            UIElements.prizeGrid.innerHTML = '';
            const savedPrizes = JSON.parse(localStorage.getItem('pokerPrizeData')) || initialPrizes;
            savedPrizes.forEach((value, index) => createPrizeField(index + 1, value));
            calculateTotals();
        };

        const updatePublicPrizes = (grandTotal) => {
            UIElements.publicPrizeGrid.innerHTML = '';
            let totalPercent = 0;
            document.querySelectorAll('.prize-percent-input').forEach((input, index) => {
                const percent = parseFloat(input.value) || 0;
                totalPercent += percent;
                const value = (grandTotal * percent) / 100;
                input.nextElementSibling.textContent = `R$ ${value.toFixed(2)}`;
                const place = index + 1;
                let color = place === 1 ? 'text-yellow-300' : (place === 2 ? 'text-gray-300' : 'text-orange-400');
                const prizeDiv = document.createElement('div');
                prizeDiv.className = 'bg-black/20 p-4 rounded-lg';
                prizeDiv.innerHTML = `<p class="block text-sm font-medium uppercase">${place}º Lugar</p><p class="mt-2 text-xl font-semibold ${color}">R$ ${value.toFixed(2)}</p>`;
                if (value > 0) {
                    UIElements.publicPrizeGrid.appendChild(prizeDiv);
                }
            });
            UIElements.percentageWarning.classList.toggle('hidden', Math.round(totalPercent) === 100 || totalPercent === 0);
        };

        // --- LÓGICA DO TIMER (ORIGINAL) ---
        const updateTimerDisplay = () => {
            const minutes = Math.floor(timerState.timeLeft / 60).toString().padStart(2, '0');
            const seconds = (timerState.timeLeft % 60).toString().padStart(2, '0');
            UIElements.timerDisplay.textContent = `${minutes}:${seconds}`;
            const currentLevelInfo = blindLevels[timerState.currentLevel];
            if (currentLevelInfo && currentLevelInfo.isBreak) { UIElements.currentBlindsDisplay.textContent = "PAUSA"; UIElements.blindsNote.textContent = currentLevelInfo.note || ''; } else { UIElements.currentBlindsDisplay.textContent = currentLevelInfo ? currentLevelInfo.blinds : '--/--'; UIElements.blindsNote.textContent = currentLevelInfo?.note || ''; }
            let nextBlindLevel = null;
            for (let i = timerState.currentLevel + 1; i < blindLevels.length; i++) { if (!blindLevels[i].isBreak) { nextBlindLevel = blindLevels[i]; break; } }
            UIElements.nextBlindsDisplay.textContent = nextBlindLevel ? nextBlindLevel.blinds : 'Fim';
            UIElements.levelIndicator.textContent = `(Nível ${timerState.currentLevel + 1}/${blindLevels.length})`;
        };
        const stopLocalTimer = () => { clearInterval(timerInterval); timerInterval = null; };
        const nextLevel = () => { if (timerState.currentLevel < blindLevels.length - 1) { setLevel(timerState.currentLevel + 1); } else { pauseTimer(); } };
        const runLocalTimer = () => { if (timerState.timeLeft > 0) { timerState.timeLeft--; updateTimerDisplay(); } else { nextLevel(); } };
        const saveTimerStateToFirebase = async (state) => { await setDoc(timerDocRef, { ...state, lastUpdateTime: state.isRunning ? serverTimestamp() : null }, { merge: true }); };
        const startTimer = () => { if (timerState.isRunning) return; timerState.isRunning = true; saveTimerStateToFirebase(timerState); };
        const pauseTimer = () => { if (!timerState.isRunning) return; timerState.isRunning = false; saveTimerStateToFirebase(timerState); };
        const setLevel = (levelIndex) => { const newLevelInfo = blindLevels[levelIndex]; const duration = newLevelInfo.isBreak ? newLevelInfo.duration : parseInt(UIElements.levelDurationInput.value); timerState = { currentLevel: levelIndex, timeLeft: duration * 60, isRunning: timerState.isRunning }; saveTimerStateToFirebase(timerState); };
        const prevLevel = () => { if (timerState.currentLevel > 0) setLevel(timerState.currentLevel - 1); };
        const resetTimer = () => { pauseTimer(); setLevel(0); };
        
        // --- LISTENERS DE EVENTOS ---
        const setupListeners = () => {
            UIElements.loginForm.addEventListener('submit', (e) => { e.preventDefault(); if (UIElements.passwordInput.value === CORRECT_PASSWORD) { sessionStorage.setItem('pokerAppLoggedIn', 'true'); showLoggedInState(); closeLoginModal(); } else { UIElements.loginError.textContent = 'Palavra-passe incorreta.'; } });
            UIElements.logoutBtn.addEventListener('click', showLoggedOutState);
            UIElements.adminLoginBtn.addEventListener('click', openLoginModal);
            UIElements.loginCancelBtn.addEventListener('click', closeLoginModal);
            UIElements.addPlayerBtn.addEventListener('click', () => { if (isUpdatingFromFirebase) return; playersData.push({ name: '', buyInChecked: false, rebuysChecked: Array(10).fill(false), addOnChecked: false, eliminated: false }); renderAll(); saveData(); });
            UIElements.resetGameBtn.addEventListener('click', () => openPasswordModal());
            UIElements.passwordConfirmBtn.addEventListener('click', () => { if (UIElements.passwordInputModal.value === CORRECT_PASSWORD) { resetGame(); closePasswordModal(); UIElements.passwordInputModal.value = ''; } else { UIElements.passwordErrorModal.textContent = 'Palavra-passe incorreta.'; } });
            UIElements.passwordCancelBtn.addEventListener('click', closePasswordModal);
            UIElements.playerTableBody.addEventListener('input', (e) => { if (isUpdatingFromFirebase) return; const row = e.target.closest('.player-row'); if (!row) return; const rowIndex = Array.from(UIElements.playerTableBody.children).indexOf(row); const player = playersData[rowIndex]; if (!player) return; const target = e.target; if (target.classList.contains('player-name')) player.name = target.value; else if (target.classList.contains('buy-in-cb')) player.buyInChecked = target.checked; else if (target.classList.contains('add-on-cb')) player.addOnChecked = target.checked; else if (target.classList.contains('rebuy-cb')) { const rebuyIndex = Array.from(row.querySelectorAll('.rebuy-cb')).indexOf(target); if (rebuyIndex !== -1) player.rebuysChecked[rebuyIndex] = target.checked; } calculateTotals(); saveData(); });
            UIElements.playerTableBody.addEventListener('click', (e) => { const button = e.target.closest('button'); if (!button || isUpdatingFromFirebase) return; const row = button.closest('.player-row'); if (!row) return; const rowIndex = Array.from(UIElements.playerTableBody.children).indexOf(row); const player = playersData[rowIndex]; if (!player) return; if (button.classList.contains('eliminate-player-btn')) player.eliminated = !player.eliminated; else if (button.classList.contains('delete-player-btn')) { openModal(`Deseja remover "${player.name || 'Jogador sem nome'}"?`, () => { playersData.splice(rowIndex, 1); renderAll(); saveData(); closeModal(); }); return; } renderAll(); saveData(); });
            UIElements.timerControlButton.addEventListener('click', () => { if (timerState.isRunning) { pauseTimer(); } else { startTimer(); } });
            UIElements.resetTimerButton.addEventListener('click', resetTimer);
            UIElements.prevLevelBtn.addEventListener('click', prevLevel);
            UIElements.nextLevelBtn.addEventListener('click', nextLevel);
            UIElements.addPrizeBtn.addEventListener('click', () => { createPrizeField(UIElements.prizeGrid.children.length + 1, 0); saveData(); });
            UIElements.prizeGrid.addEventListener('input', () => { calculateTotals(); saveData(); });
            UIElements.prizeGrid.addEventListener('click', (e) => { if (e.target.classList.contains('remove-prize-btn')) { e.target.closest('.prize-item').remove(); UIElements.prizeGrid.querySelectorAll('.prize-item label').forEach((label, index) => { label.textContent = `${index + 1}º Lugar`; }); renderAll(); saveData(); } });
            UIElements.modalConfirmBtn.addEventListener('click', () => { if(confirmCallback) confirmCallback(); });
            UIElements.modalCancelBtn.addEventListener('click', closeModal);
        };
        
        // --- INICIALIZAÇÃO E LISTENERS PRINCIPAIS ---
        const openModal = (text, onConfirm) => { UIElements.modalText.textContent = text; confirmCallback = onConfirm; UIElements.confirmationModal.classList.remove('hidden'); };
        const closeModal = () => UIElements.confirmationModal.classList.add('hidden');
        const openPasswordModal = () => { UIElements.passwordInputModal.value = ''; UIElements.passwordErrorModal.textContent = ''; UIElements.passwordModal.classList.remove('hidden'); UIElements.passwordInputModal.focus(); };
        const closePasswordModal = () => UIElements.passwordModal.classList.add('hidden');
        
        onSnapshot(gameDocRef, (docSnapshot) => {
            console.log("%cSNAPSHOT gameState RECEBIDO!", "color: green;");
            isUpdatingFromFirebase = true;
            if (docSnapshot.exists() && docSnapshot.data().players) {
                const data = docSnapshot.data();
                if (currentGameId === null) {
                    currentGameId = data.gameId;
                    console.log(`Sincronizando com o jogo ID: ${currentGameId}`);
                }
                if (!data.gameId || data.gameId !== currentGameId) {
                    console.error(`DADOS INVÁLIDOS REJEITADOS! ID esperado: ${currentGameId}, ID recebido: ${data.gameId || 'NENHUM'}.`);
                    isUpdatingFromFirebase = false; saveData(); return;
                }
                playersData = data.players;
            } else {
                console.log("Documento não existe. Criando novo jogo.");
                resetGame();
            }
            renderAll();
            setTimeout(() => { isUpdatingFromFirebase = false; console.log("%cTrava liberada.", "color: gray;"); }, 500);
        });

        onSnapshot(timerDocRef, (docSnapshot) => {
            if (docSnapshot.exists()) {
                const latestState = docSnapshot.data();
                if (latestState.isRunning) {
                    const now = Date.now();
                    const lastUpdate = latestState.lastUpdateTime?.toMillis() || now;
                    const timeElapsed = Math.floor((now - lastUpdate) / 1000);
                    const newTimeLeft = Math.max(0, latestState.timeLeft - timeElapsed);
                    timerState = { ...latestState, timeLeft: newTimeLeft };
                    if (!timerInterval) { timerInterval = setInterval(runLocalTimer, 1000); UIElements.timerControlButton.textContent = 'Pausar'; UIElements.timerControlButton.classList.replace('bg-green-600', 'bg-yellow-600'); }
                } else {
                    timerState = latestState;
                    stopLocalTimer(); UIElements.timerControlButton.textContent = 'Iniciar'; UIElements.timerControlButton.classList.replace('bg-yellow-600', 'bg-green-600');
                }
            } else {
                setDoc(timerDocRef, { timeLeft: parseInt(UIElements.levelDurationInput.value) * 60, currentLevel: 0, isRunning: false, lastUpdateTime: null });
            }
            updateTimerDisplay();
        });
        
        setupListeners();
        if (sessionStorage.getItem('pokerAppLoggedIn') === 'true') {
            showLoggedInState();
        } else {
            showLoggedOutState();
        }
    };
});
</script>
</body>
</html>
